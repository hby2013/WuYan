var story_data = [[{"bg_img":"img/scene/China1.jpg","character":"","word":"不知来了多少次的T2航站楼，似乎随时都保持着活力。"},
            {"bg_img":"img/scene/China1.jpg","character":"","word":"世界各地的人们来往于首都国际机场，忙着在这个不断崛起的首都留下自己的气息。而我手握着登机牌，急切地想要逃离这个生活了30年的故乡。"},
            {"bg_img":"img/scene/China2.jpg","character":"img/character/waitress.png","word":"\"您的卡布奇诺好了，欢迎下次光临。\""},
            {"bg_img":"img/scene/China2.jpg","character":"","word":"接过热腾腾的咖啡，我在starbucks找了一个角落坐下。记不清什么时候开始，冉冉最爱的卡布奇诺也成为我每次出发前的必选。"},
            {"bg_img":"img/scene/China2.jpg","character":"","word":"可能是卡布奇诺的味道总能让我回想起她握杯时白而微胖的双手，和沉浸在热腾腾的香气中圆润的脸。"},
            {"bg_img":"img/scene/China1.jpg","character":"","word":"\"各位旅客请注意，您所乘坐的G132次航班现在开始登机，请携带好您的随身物品由11号登机口上飞机，祝您旅途愉快，谢谢！\""},
            {"bg_img":"img/scene/China1.jpg","character":"","word":"\"要出发了，去韩国。\""},
            {"bg_img":"img/scene/China1.jpg","character":"","word":"以往我都会在出发前给冉冉发上这么一条消息，但这次没有。拿上行李，我独自向登机口走去。"}
           ],[],
           [{"bg_img":"img/scene/Korea1.jpg","character":"","word":"之所以选择韩国作为我周游世界的第一站，是因为它是我和冉冉第一次二人旅游的目的地。"},
            {"bg_img":"img/scene/Korea1.jpg","character":"","word":"许冉，是我的前女友，她就像那些普通的女孩一样，爱看韩剧，爱吃韩式烤肉，在冬天喜欢在及膝的黑羽绒服下露出雪白的脚踝，打扮得像韩国留学生。"},
            {"bg_img":"img/scene/Korea1.jpg","character":"","word":"学生时代的我们资金紧张，负担不起去欧美国家的昂贵机票。于是在大一的十一前夕，我们订下了去首尔的打折机票，为之后无数次的二人旅行开了头。"},
            {"bg_img":"img/scene/Korea2.jpg","character":"","word":"别看冉冉第一次出国，大一的她可不比那些“身经百战”的旅行者们差劲。她在出发前就做足了功课，知道深夜的东大门是各地服装商的乐园，能以超值的价格淘到心仪的潮款。"},
            {"bg_img":"img/scene/Korea2.jpg","character":"img/character/ran_excited.png","word":"\"那些都是负责送货的人，大部分中国的服装商贩在东大门进货之后，都会委托他们把这些衣服寄回商贩们所在的城市，方便又便宜。\""},
            {"bg_img":"img/scene/Korea2.jpg","character":"","word":"18岁的冉冉指着马路边一个个守着大包小包衣服的年轻人，兴奋地向我展示着她出发前做功课的成果。"},
            {"bg_img":"img/scene/Korea2.jpg","character":"img/character/ran_sad.png","word":"\"他们好辛苦啊，在路边一呆就是一整晚。\""},
            {"bg_img":"img/scene/Korea2.jpg","character":"","word":" 如今，30岁的我只身一人来到东大门，满眼都是18岁的我俩在这里血拼到黎明的样子。路边负责送货的人们依旧在寒风中守着大包小包。"},
            {"bg_img":"img/scene/Korea2.jpg","character":"","word":" 入夜后气温慢慢变冷，我紧了紧头上羽绒服的兜帽，伸手拦下一辆出租车，返回在江南区的五星酒店。"}],
            [{"bg_img":"img/scene/Japan1.jpg","character":"","word":"我是个风险投资人。多亏现在资金所在的几个互联网公司都发展得不错，我才能有大把的时间来环游世界。"},
            {"bg_img":"img/scene/Japan1.jpg","character":"","word":"上个月收到了冉冉婚礼的请柬，虽然知道她和现任男友进展很快，但当现实真的摆在面前时，对我的打击还是超出了我的控制范围。"},
            {"bg_img":"img/scene/Japan1.jpg","character":"","word":"我和冉冉是高中同学，高二时相恋，爱情长跑了十年，最终还是没能修成正果。"},
            {"bg_img":"img/scene/Japan1.jpg","character":"","word":"离开首尔，我的第二个目的地选择了东京。这里又是一个我和冉冉回忆的重灾区，我的环游世界仿佛只是为了远离她本人，而靠回忆去舔舐我的伤口。"},
            {"bg_img":"img/scene/Japan1.jpg","character":"","word":"日本文化一直是我的最爱，这个细腻到骨子里的民族总能打动你心里最柔软的那部分。"},
            {"bg_img":"img/scene/Japan1.jpg","character":"","word":"彼时的我们一起去筑地海鲜市场排长队，只为品尝一碗吃不太惯的金枪鱼饭；她陪我去涩谷找寻《东京爱情故事》里的那个公园，"},
            {"bg_img":"img/scene/Japan1.jpg","character":"","word":"我陪她去各大药妆店买个不停，游戏厅对着看不懂的日文机器疯狂投币。我重游了每一个我们到过的地方，回忆扑面而来，炽热如初。"},
            {"bg_img":"img/scene/Japan2.jpg","character":"","word":"我还记得两年前我们的最后一次旅行，在东京的最后一天，狭小的宾馆房间被行李箱挤得几乎没有下脚的空间。"}, 
            {"bg_img":"img/scene/Japan2.jpg","character":"img/character/ran_peace.png","word":"\"久越，我们结束吧。再这样下去我会窒息。\""},
            {"bg_img":"img/scene/Japan2.jpg","character":"","word":"我看不到她的眼睛，她也再没有回过头来看我。"},
            {"bg_img":"img/scene/Japan3.jpg","character":"","word":"两年后的我在同一家酒店住了一周，在楼层等待乘电梯到大堂退房。电梯开门，里面只有一位陌生的亚洲妇女。"},
            {"bg_img":"img/scene/Japan3.jpg","character":"","word":"她很自然地向我点头问好，而我大概反应了一秒才略显尴尬地向她点头回礼，然后站到电梯的一个角落里，心想她一定是位日本女性。"}],[],[],[],[],[],[],[],
            [{"bg_img":"img/scene/Thailand1.jpg","character":"","word":"\"Ladies and Gentlemen, we will be landing at Don Mueang International Airport in about 30 minutes.\""},
            {"bg_img":"img/scene/Thailand1.jpg","character":"","word":"飞机到达泰国的领空。这个经济刚刚起步的亚洲四小虎之一，每年都会吸引大批大陆的游客。"},
            {"bg_img":"img/scene/Thailand1.jpg","character":"","word":"泰国是著名的佛教之国，国民中有90%信佛，佛文化渗入了这个国家的每个角落。和北京相比，泰国的消费水平极低，大学时期的我和冉冉自然也把它列为了几个最先游玩的国家之一。"},
            {"bg_img":"img/scene/Thailand1.jpg","character":"img/character/happy.png","word":"\"あの,すみません（对不起 打扰一下）。\""},
            {"bg_img":"img/scene/Thailand1.jpg","character":"","word":"旁边突然有人向我问话，我侧头一看，是邻座的日本姑娘。"},
            {"bg_img":"img/scene/Thailand1.jpg","character":"","word":"她一路上都在翻阅自己单反相机里的照片，我虽然也是飞行的老手，但遗传的小脑让我几乎晕一切交通工具，于是我对能在交通工具里随意浏览电子设备的人都格外羡慕。"},
            {"bg_img":"img/scene/Thailand1.jpg","character":"","word":"\"Sorry, I'm Chinese.（对不起 我是中国人）\""},
            {"bg_img":"img/scene/Thailand1.jpg","character":"","word":"我用英语回答她，顺便也有了仔细观察她的机会。日本姑娘大概25岁左右，鹅蛋脸上可以看出浅浅的底妆。留着有点男孩子气的短发，五官算不上精致，但水灵的眼睛和说话时露出的虎牙显出日本女生独有的可爱。"},
            {"bg_img":"img/scene/Thailand1.jpg","character":"img/character/happy.png","word":"\"那没关系，我会说中文。\""},
            {"bg_img":"img/scene/Thailand1.jpg","character":"img/character/shy.png","word":"\"我想问你一下，我的谷歌地图到泰国为什么打不开了啊？\""},
            {"bg_img":"img/scene/Thailand1.jpg","character":"","word":"说着，她递过来自己的智能手机。我接过来稍微检查了一下，很快发现了问题。"},
            {"bg_img":"img/scene/Thailand1.jpg","character":"","word":"\"你的手机没有联网啊，当然打不开地图。\""},
            {"bg_img":"img/scene/Thailand1.jpg","character":"img/character/poor.png","word":"\"啊，刚刚还能用3G网呢，那现在应该怎么办啊，没有地图我肯定会在曼谷迷路……\""},
            {"bg_img":"img/scene/Thailand1.jpg","character":"","word":"姑娘用带着一丝惭愧的眼神向我求助。连手机网络在出国旅游中的基本常识都没摸清，就敢自己一个人飞来泰国，我心里暗暗佩服这位日本姑娘的勇气。"},
            {"bg_img":"img/scene/Thailand1.jpg","character":"","word":"\"这样吧，你先连接我的wifi，然后下载曼谷的离线地图，之后你再查看地图就不需要网络了。\""},
            {"bg_img":"img/scene/Thailand1.jpg","character":"img/character/happy.png","word":"\"那真是太感谢你了！\""},
            {"bg_img":"img/scene/Thailand1.jpg","character":"","word":"姑娘拉着我的手一个劲儿道谢，这份突如其来的热情让我有些不知所措，毕竟上次有女生和我这么亲近已经是两年前了。"}],[],[],[],[],
            [{"bg_img":"img/scene/India1.jpg","character":"","word":"现在我站在孟买的印度门前，这座酷似法国凯旋门的建筑是印度最著名的旅游景点之一，自然也留下过我和冉冉的足迹。往日的画面慢慢浮现。"},
            {"bg_img":"img/scene/India1.jpg","character":"img/character/ran_excited.png","word":"\"来~就这个姿势，快给我来一张精美的抓拍！\""},
            {"bg_img":"img/scene/India1.jpg","character":"","word":"冉冉冲到我面前十米左右的距离，然后一个潇洒的转身。孟买湾上的阳光打到她的纯白T恤和浅色牛仔裤，她本来就白皙的皮肤显得更亮了。"},
            {"bg_img":"img/scene/India1.jpg","character":"","word":"\"等我调一下曝光啊。\""},
            {"bg_img":"img/scene/India1.jpg","character":"","word":"年轻的我正低头调整手中单反的曝光参数。我那时刚刚学习摄影，正处于吸收了很多理论知识却没有实践经验的阶段。"},
            {"bg_img":"img/scene/India1.jpg","character":"img/character/ran_tired.png","word":"\"参数差不多就好啦，快点我姿势都摆累了~\""},
            {"bg_img":"img/scene/India1.jpg","character":"","word":"\"别着急啊，等我找一下构图……嗯，你再往那边站一点……停，再回来一点……嗯，这个角度差不多。\""},
            {"bg_img":"img/scene/India1.jpg","character":"","word":"我一边透过取景框观察，一边指挥着冉冉。见我按下了快门，冉冉颠颠地凑到我身边。"},
            {"bg_img":"img/scene/India1.jpg","character":"img/character/ran_happy.png","word":"\"这不拍得挺不错的嘛，大摄影家~\""},
            {"bg_img":"img/scene/India1.jpg","character":"","word":"\"嗯，还可以吧，但我感觉曝光还是过了点……\""},
            {"bg_img":"img/scene/India1.jpg","character":"","word":"我显然还是对自己的作品不大满意。冉冉抬起头来，突然眼冒金光,"},
            {"bg_img":"img/scene/India1.jpg","character":"img/character/ran_happy.png","word":"\"久越，咱们以后开个跟旅游有关的公司吧，这样就可以一直出来玩了。\""},
            {"bg_img":"img/scene/India1.jpg","character":"","word":"\"傻姑娘，开公司哪有那么简单，首先得有个好的创意才行。\""},
            {"bg_img":"img/scene/India1.jpg","character":"img/character/ran_strange.png","word":"\"久越你那么聪明，肯定能想出好点子的。\""},
            {"bg_img":"img/scene/India1.jpg","character":"","word":"\"光有理念也不行啊，还得有资金，有好的机遇……\""},
            {"bg_img":"img/scene/India1.jpg","character":"","word":"冉冉微微一笑，也不理会正大谈创业经的我，自顾自地走向印度门硕大的门洞。"}]
]; 

var images = ["img/scene/China1.jpg","img/scene/China2.jpg","img/scene/Korea1.jpg","img/scene/Korea2.jpg","img/scene/Japan1.jpg","img/scene/Japan2.jpg","img/scene/Japan3.jpg",
              "img/character/happy.png","img/character/poor.png","img/character/shy.png","img/character/ran_excited.png","img/character/ran_happy.png","img/character/ran_peace.png","img/character/ran_sad.png","img/character/ran_strange.png","img/character/ran_tired.png"];

var current_story_data = [];              
var current_scene = 0;  
var word_finished = false;
var story_unfinished = [];

function preload_images(){
    var pre_images = new Array;
    for(var i = 0; i < images.length; i++){
        pre_images[i] = new Image();
        pre_images[i].src = images[i];
    }
}

function set_font(){
    var size = $(window).height * 0.04;
    $(document.body).css("font-size",size);
}

function set_bg_img(bg_src){
    $("#bg_img")[0].src = bg_src;
    var bg_img = new Image();
    bg_img.src = bg_src;
    bg_img.onload = function(){
        var ratio1 = bg_img.height / bg_img.width;
        var ratio2 = $(window).height()/$(window).width();
        if(ratio1 < ratio2){
            $("#bg_img").css("height",$(window).height());
            $("#bg_img").css("width", $(window).height() / ratio1);
            $("#bg_img").css("left", -($("#bg_img").width() - $(window).width())/2);
            $("#bg_img").css("top",0);
        }
        else{
            $("#bg_img").css("width",$(window).width());
            $("#bg_img").css("height", $(window).width() * ratio1);
            $("#bg_img").css("left", 0);
            $("#bg_img").css("top", -($("#bg_img").height() - $(window).height())/2);
        }
    }
}

var showText = function (message, index, interval) {
    if (index < message.length) {
        $("#word").append(message[index++]);
        timeID = setTimeout(function () { showText(message, index, interval); }, interval);
    }
    else{
        word_finished = true;
    }
}

function set_character(character){
    if(character == ""){
        $("#character").css("display","none");
    }
    else{
        $("#character").css("display","block");
        $("#character")[0].src = character;
    }
    
}

function next_scene(){
    if(word_finished == false){
        clearTimeout(timeID);
        $("#word").html(current_story_data[current_scene].word);
        word_finished = true;
    }
    else{    
        current_scene ++;
        if(current_scene < current_story_data.length){
            refresh_map();
            word_finished = false;
            set_bg_img(current_story_data[current_scene].bg_img);
            $("#word").html("");
            set_character(current_story_data[current_scene].character);
            showText(current_story_data[current_scene].word,0,20);
        }
        else{
            story_unfinished.shift();
            if(story_unfinished.length != 0){
                current_story_data = story_unfinished[0];
                current_scene = 0;  
                word_finished = false;
                $("#word").html("");
                preload_images();
                set_font();
                set_character(current_story_data[0].character);
                set_bg_img(current_story_data[0].bg_img);
                setTimeout(function(){
                    $("#story").css("display","block");
                },1000);
                setTimeout(function(){
                    showText(current_story_data[0].word, 0, 20);
                },1500);
            }
            else{
                $("#story_div").css("display","none");
            }
        }
    }
}


function refresh_map(){
    $("#intro_container").css("opacity","1");
    $("#bg_map").attr("src", "img/map/"+country_data.Ename2+".png");
    $("#bg_map").css("top", ($("#country").height() - $("#bg_map").height())/2);
    $("#bg_map").css("opacity","0.3");
    $("#next_map").attr("src","img/map/"+country_data.Ename3+".png");
    $("#next_map").css("height",$("#next_map_container").height());
    $("#next_map").css("width","");
    $("#next_map").css("bottom",0);
    $("#next_map").css("right",0);
    $("#country_name").html(country_data.Cname2);
    $("#country_pic").attr("src", "img/world_images/"+country_data.Ename2+".jpg");
    $("#country_info").html(country_data.intro2);
    $("#next_country_name").html(country_data.Cname3);
    $("#next_country_step").html(country_data.step);
    $("#progressbar").progressbar({value: (20000-country_data.step)/200});
    $("#progress_num").html((20000-country_data.step)/200+"%");
}