<!DOCTYPE html>  
<html xmlns="http://www.w3.org/1999/xhtml">  
<head>  
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>附近的人</title>  
    <!--css-->  
    <link href="css/demo.css" rel="stylesheet" type="text/css" />  
    <!--javascript-->  
    <script src="js/jquery.js" type="text/javascript"></script>  
    <script src="scripts/demo.js" type="text/javascript"></script>  
    <script src="js/Chart-1.0.1-beta.4.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.5&ak=56hSBkT6lEQ5hWlVLRgnqnLY"></script>  
    <script type="text/javascript" src="http://developer.baidu.com/map/jsdemo/demo/convertor.js"></script>
    <!--<script type="text/javascript" src="js/transmore.js"></script>-->
</head>  
<body style = "margin:0;padding:0;background-color:#eeeeee">  
    <div class="demo_main">   
        <div class="demo_content">  
            <div style="position:absolute;min-height: 50%; width: 100%;" id="map">  
            </div> 
            <script type="text/javascript">  
                var markerArr = [  
                    { nickname: "池婧雯", point: "116.320786,40.008045", icon:"img/head2.jpg",data:[28,48,40,70,23,34]},  
                    { nickname: "谢宇辰", point: "116.3230934,40.0113401", icon:"img/head3.jpg", data:[28,18,30,30,13,24]},  
                    { nickname: "夏英达", point: "116.3212213,40.0147267", icon:"img/head4.jpg", data:[28,28,20,10,33,54]},  
                    { nickname: "黄冰洋", point: "116.3272867,40.0134274", icon:"img/head5.jpg", data:[28,38,10,20,13,44]},
                    { nickname: "赵雷彧", point: "116.3222867,40.0124274", icon:"img/head6.jpg", data:[28,48,30,50,13,24]},
                    { nickname: "王昳涵", point: "116.3274867,40.0116274", icon:"img/head7.jpg", data:[28,58,20,40,13,34]}  
                ];  
                var data = {
                    labels : ["当天步数","周平均步数","当天卡路里","周平均卡路里","当天运动时间","周平均运动时间"],
                    datasets : [
                        {
                            fillColor : "rgba(220,220,220,0.5)",
                            strokeColor : "rgba(220,220,220,1)",
                            pointColor : "rgba(220,220,220,1)",
                            pointStrokeColor : "#fff",
                            data : [28,48,40,70,23,34]
                        },
                        {
                            fillColor : "rgba(151,187,205,0.5)",
                            strokeColor : "rgba(151,187,205,1)",
                            pointColor : "rgba(151,187,205,1)",
                            pointStrokeColor : "#fff",
                            data : [28,18,30,30,13,24]
                        }
                    ]
                };
                var map;
                var point;
                var current_point = 0;
                var can_continue = true;
                function map_init() {  
                    map = new BMap.Map("map"); // 创建Map实例  
                    var point = new BMap.Point(116.320786,40.008045); 
                    map.centerAndZoom(point, 17); // 初始化地图,设置中心点坐标和地图级别。  
                    
                    map.enableScrollWheelZoom(true); //启用滚轮放大缩小  
                    //向地图中添加缩放控件  
                    var ctrlNav = new window.BMap.NavigationControl({  
                        anchor: BMAP_ANCHOR_TOP_LEFT,  
                        type: BMAP_NAVIGATION_CONTROL_LARGE  
                    });  
                    map.addControl(ctrlNav);  
                    
                    //向地图中添加缩略图控件  
                    var ctrlOve = new window.BMap.OverviewMapControl({  
                        anchor: BMAP_ANCHOR_BOTTOM_RIGHT,  
                        isOpen: 1  
                    });  
                    map.addControl(ctrlOve);  
                    
                    //向地图中添加比例尺控件  
                    var ctrlSca = new window.BMap.ScaleControl({  
                        anchor: BMAP_ANCHOR_BOTTOM_LEFT  
                    });  
                    map.addControl(ctrlSca);  
                    var marker = new Array(); //存放标注点对象的数组  
                    var info = new Array(); //存放提示信息窗口对象的数组 
                    current_point = 0;
                    point = new Array(); //存放标注点经纬信息的数组  
                    for (var i = 0; i < markerArr.length; i++) {  
                        var p0 = markerArr[i].point.split(",")[0]; //  
                        var p1 = markerArr[i].point.split(",")[1]; //按照原数组的point格式将地图点坐标的经纬度分别提出来  
                        point[i] = new window.BMap.Point(p0, p1); //循环生成新的地图点  
                        //debugger;
                        //marker[i] = new window.BMap.Marker(point[i]); //按照地图点坐标生成标记 
                        BMap.Convertor.translate(point[i],0,generator(i)); 
                        //map.addOverlay(marker[i]);  
                        //marker[i].setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画  
                        //var label = new window.BMap.Label(markerArr[i].nickname, { offset: new window.BMap.Size(20, -10) });  
                        //marker[i].setLabel(label);  
                        //info[i] = new window.BMap.InfoWindow("<p style=’font-size:12px;lineheight:1.8em;’>" + markerArr[i].nickname + "</br>地址：" + markerArr[i].address + "</br> 电话：" + markerArr[i].tel + "</br></p>"); // 创建信息窗口对象  
                    }  
                    //BMap.Convertor.transMore(point,0,callback);
                }  
                
                function callback(xyResult){ 
                    if(xyResult.error != 0){return;}//出错就直接返回;
                    var new_point = new BMap.Point(xyResult.x, xyResult.y);
                    var marker = new BMap.Marker(new_point);
                    map.addOverlay(marker);
                    var label = new BMap.Label(markerArr[current_point].nickname, { offset: new window.BMap.Size(20, -10)});
                    marker.setLabel(label); //添加百度label
                    var i = current_point;
                    marker.onclick = function () {
                        document.getElementById("icon2").src = markerArr[i].icon;
                        document.getElementById("nickname2").innerText = markerArr[i].nickname;
                        data.datasets[1].data = markerArr[i].data;
                        createChart();
                        calculate_similarity(0,i);
                    };
                    map.setCenter(new_point);
                    current_point ++;
                }
                
                //坐标转换完之后的回调函数
                function generator(i)
                {
                    return function translateCallback(point1){
                        var marker1 = new BMap.Marker(point1);
                        map.addOverlay(marker1);
                        var label = new BMap.Label(markerArr[i].nickname, { offset: new window.BMap.Size(20, -10)});
                        marker1.setLabel(label); //添加百度label
                        map.setCenter(point1);              
                        marker1.onclick = function () {document.getElementById("icon2").src = markerArr[i].icon;};
                        can_continue = true;
                    };
                }
                
                var defaults = {
                    scaleFontFamily : "微软雅黑",
                    scaleFontSize : 10,
                    animation : true,
                    pointDotRadius : 3,
                }
                
                //异步调用百度js  
                function map_load() { 
                    //get_data();
                    var load = document.createElement("script");  
                    load.src = "http://api.map.baidu.com/api?v=1.5&callback=map_init&ak=56hSBkT6lEQ5hWlVLRgnqnLY";  
                    document.body.appendChild(load);  
                    createChart();
                    calculate_similarity(0,1);
                }  
                
                function get_data(){
                    $.ajax({
                        type:'get',
                        url:"/getrankinginfo",
                        dataType:"json",
                        success:function(data){
                            for(var i = 0; i < data.lengh; i++){
                                markerArr[i].icon = data[i].icon;
                            }
                        }
                    });
                }
                
                function createChart(){
                    $("#myChart").remove();
                    $("<canvas id='myChart' ></canvas>").appendTo($("#user_info"));
                    var ctx = document.getElementById("myChart").getContext("2d");
                    new Chart(ctx).Radar(data, defaults);
                    $("#myChart").height($("#myChart").width() * 0.5);
                    var info_top = ($("#user_info").height() - $("#myChart").width() * 0.5)/2; 
                    $("#myChart").css("top",info_top-50);
                    $("#similary").css("top",info_top + $("#myChart").height());
                    $("#similary").css("left",info_top + $("#myChart").height());
                    $(".user_info0").css("top",info_top);
                }
                
                function calculate_similarity(m,n){
                    var data1 = markerArr[m].data;
                    var data2 = markerArr[n].data;
                    var s = 0;
                    for(var i =0; i < data1.length ;i++)
                    {
                        s += 1 - Math.abs(parseFloat(data1[i]) - parseFloat(data2[i])) / parseFloat(data1[i]);
                    }
                    s = (s/data1.length * 100).toFixed(2);
                    document.getElementById("similary").innerHTML = "匹配度:<b style= 'color:red;font-size:2em'>"+s+"%</b>"; 
                }
                window.onload = map_load;  
            </script>  
        </div>  
    </div>  
    <div id = "user_info" style = "position:absolute;width:100%;height:50%;top:50%">
        <div class = "user_info0" style = "position:absolute;width:15%;left:5%;height:50%;">
            <img class = "user_head" src = "img/head2.jpg" style = "width:100%;border-radius:50%;"/>
            <div class = "user_name" style = "text-align:center;font-size:18px">池婧雯</div>
        </div>
        <canvas id="myChart" ></canvas>
        <div id = "similary" style="position:absolute;">匹配度:<b style= "color:red;font-size:2em">90%</b></div>
        <div class = "user_info0" style = "position:absolute;width:15%;left:80%;height:50%;">
            <img id = "icon2" src = "img/head3.jpg" style = "width:100%;border-radius:50%;"/>
            <div id = "nickname2" class = "username" style = "text-align:center;font-size:18px">谢宇辰</div>
        </div>        
    </div>
</body>  
</html>  
