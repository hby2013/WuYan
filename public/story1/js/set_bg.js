var story_data = [[{"bg_img":"航站楼1.jpg","character":"","word":"不知来了多少次的T2航站楼，似乎随时都保持着活力。"},
            {"bg_img":"航站楼.jpg","character":"","word":"世界各地的人们来往于首都国际机场，忙着在这个不断崛起的首都留下自己的气息。而我手握着登机牌，急切地想要逃离这个生活了30年的故乡。"},
            {"bg_img":"咖啡厅1.jpg","character":"character/waitress.png","word":"\"您的卡布奇诺好了，欢迎下次光临。\""},
            {"bg_img":"咖啡厅1.jpg","character":"","word":"接过热腾腾的咖啡，我在starbucks找了一个角落坐下。记不清什么时候开始，冉冉最爱的卡布奇诺也成为我每次出发前的必选。"},
            {"bg_img":"咖啡厅1.jpg","character":"","word":"可能是卡布奇诺的味道总能让我回想起她握杯时白而微胖的双手，和沉浸在热腾腾的香气中圆润的脸。"},
            {"bg_img":"航站楼.jpg","character":"","word":"\"各位旅客请注意，您所乘坐的G132次航班现在开始登机，请携带好您的随身物品由11号登机口上飞机，祝您旅途愉快，谢谢！\""},
            {"bg_img":"航站楼.jpg","character":"","word":"\"要出发了，去韩国。\""},
            {"bg_img":"航站楼.jpg","character":"","word":"以往我都会在出发前给冉冉发上这么一条消息，但这次没有。拿上行李，我独自向登机口走去。"}
           ],[],
           [{"bg_img":"shouer2.jpg","character":"","word":"之所以选择韩国作为我周游世界的第一站，是因为它是我和冉冉第一次二人旅游的目的地。"},
            {"bg_img":"shouer.jpg","character":"","word":"许冉，是我的前女友，她就像那些普通的女孩一样，爱看韩剧，爱吃韩式烤肉，在冬天喜欢在及膝的黑羽绒服下露出雪白的脚踝，打扮得像韩国留学生。"},
            {"bg_img":"shouer.jpg","character":"","word":"学生时代的我们资金紧张，负担不起去欧美国家的昂贵机票。于是在大一的十一前夕，我们订下了去首尔的打折机票，为之后无数次的二人旅行开了头。"},
            {"bg_img":"东大门.jpg","character":"","word":"别看冉冉第一次出国，大一的她可不比那些“身经百战”的旅行者们差劲。她在出发前就做足了功课，知道深夜的东大门是各地服装商的乐园，能以超值的价格淘到心仪的潮款。"},
            {"bg_img":"东大门.jpg","character":"character/ran_excited.png","word":"\"那些都是负责送货的人，大部分中国的服装商贩在东大门进货之后，都会委托他们把这些衣服寄回商贩们所在的城市，方便又便宜。\""},
            {"bg_img":"东大门.jpg","character":"","word":"18岁的冉冉指着马路边一个个守着大包小包衣服的年轻人，兴奋地向我展示着她出发前做功课的成果。"},
            {"bg_img":"东大门.jpg","character":"character/ran_sad.png","word":"\"他们好辛苦啊，在路边一呆就是一整晚。\""},
            {"bg_img":"东大门.jpg","character":"","word":" 如今，30岁的我只身一人来到东大门，满眼都是18岁的我俩在这里血拼到黎明的样子。路边负责送货的人们依旧在寒风中守着大包小包。"},
            {"bg_img":"东大门.jpg","character":"","word":" 入夜后气温慢慢变冷，我紧了紧头上羽绒服的兜帽，伸手拦下一辆出租车，返回在江南区的五星酒店。"}],
            [{"bg_img":"dongjing2.jpg","character":"","word":"我是个风险投资人。多亏现在资金所在的几个互联网公司都发展得不错，我才能有大把的时间来环游世界。"},
            {"bg_img":"dongjing.jpg","character":"","word":"上个月收到了冉冉婚礼的请柬，虽然知道她和现任男友进展很快，但当现实真的摆在面前时，对我的打击还是超出了我的控制范围。"},
            {"bg_img":"dongjing.jpg","character":"","word":"我和冉冉是高中同学，高二时相恋，爱情长跑了十年，最终还是没能修成正果。"},
            {"bg_img":"dongjing.jpg","character":"","word":"离开首尔，我的第二个目的地选择了东京。这里又是一个我和冉冉回忆的重灾区，我的环游世界仿佛只是为了远离她本人，而靠回忆去舔舐我的伤口。"},
            {"bg_img":"dongjing.jpg","character":"","word":"日本文化一直是我的最爱，这个细腻到骨子里的民族总能打动你心里最柔软的那部分。"},
            {"bg_img":"dongjing.jpg","character":"","word":"彼时的我们一起去筑地海鲜市场排长队，只为品尝一碗吃不太惯的金枪鱼饭；她陪我去涩谷找寻《东京爱情故事》里的那个公园，"},
            {"bg_img":"dongjing.jpg","character":"","word":"我陪她去各大药妆店买个不停，游戏厅对着看不懂的日文机器疯狂投币。我重游了每一个我们到过的地方，回忆扑面而来，炽热如初。"},
            {"bg_img":"hotel.jpg","character":"","word":"我还记得两年前我们的最后一次旅行，在东京的最后一天，狭小的宾馆房间被行李箱挤得几乎没有下脚的空间。"}, 
            {"bg_img":"hotel.jpg","character":"character/ran_peace.png","word":"\"久越，我们结束吧。再这样下去我会窒息。\""},
            {"bg_img":"hotel.jpg","character":"","word":"我看不到她的眼睛，她也再没有回过头来看我。"},
            {"bg_img":"lift.jpg","character":"","word":"两年后的我在同一家酒店住了一周，在楼层等待乘电梯到大堂退房。电梯开门，里面只有一位陌生的亚洲妇女。"},
            {"bg_img":"lift.jpg","character":"","word":"她很自然地向我点头问好，而我大概反应了一秒才略显尴尬地向她点头回礼，然后站到电梯的一个角落里，心想她一定是位日本女性。"}],[]]; 

var images = ["航站楼.jpg","咖啡厅1.jpg","shouer.jpg","东大门.jpg","dongjing.jpg","hotel.jpg","机舱2.jpg","yindu.jpg",
              "character/happy.png","character/poor.png","character/shy.png","character/ran_excited.png","character/ran_happy.png","character/ran_peace.png","character/ran_sad.png","character/ran_strange.png","character/ran_tired.png"];

var current_story_data = [];              
var current_scene = 0;  
var word_finished = false;
var story_unfinished = [];

function preload_images(){
    var pre_images = new Array;
    for(var i = 0; i < images.length; i++){
        pre_images[i] = new Image();
        pre_images[i].src = images[i];
    }
}

function set_font(){
    var size = $(window).height * 0.04;
    $(document.body).css("font-size",size);
}

function set_bg_img(bg_src){
    $("#bg_img")[0].src = bg_src;
    var bg_img = new Image();
    bg_img.src = bg_src;
    bg_img.onload = function(){
        var ratio1 = bg_img.height / bg_img.width;
        var ratio2 = $(window).height()/$(window).width();
        if(ratio1 < ratio2){
            $("#bg_img").css("height",$(window).height());
            $("#bg_img").css("width", $(window).height() / ratio1);
            $("#bg_img").css("left", -($("#bg_img").width() - $(window).width())/2);
            $("#bg_img").css("top",0);
        }
        else{
            $("#bg_img").css("width",$(window).width());
            $("#bg_img").css("height", $(window).width() * ratio1);
            $("#bg_img").css("left", 0);
            $("#bg_img").css("top", -($("#bg_img").height() - $(window).height())/2);
        }
    }
}

var showText = function (message, index, interval) {
    if (index < message.length) {
        $("#word").append(message[index++]);
        timeID = setTimeout(function () { showText(message, index, interval); }, interval);
    }
    else{
        word_finished = true;
    }
}

function set_character(character){
    if(character == ""){
        $("#character").css("display","none");
    }
    else{
        $("#character").css("display","block");
        $("#character")[0].src = character;
    }
    
}

function next_scene(){
    if(word_finished == false){
        clearTimeout(timeID);
        $("#word").html(current_story_data[current_scene].word);
        word_finished = true;
    }
    else{    
        current_scene ++;
        if(current_scene < current_story_data.length){
            refresh_map();
            word_finished = false;
            set_bg_img(current_story_data[current_scene].bg_img);
            $("#word").html("");
            set_character(current_story_data[current_scene].character);
            showText(current_story_data[current_scene].word,0,20);
        }
        else{
            story_unfinished.shift();
            if(story_unfinished.length != 0){
                current_story_data = story_unfinished[0];
                current_scene = 0;  
                word_finished = false;
                $("#word").html("");
                preload_images();
                set_font();
                set_character(current_story_data[0].character);
                set_bg_img(current_story_data[0].bg_img);
                setTimeout(function(){
                    $("#story").css("display","block");
                },1000);
                setTimeout(function(){
                    showText(current_story_data[0].word, 0, 20);
                },1500);
            }
            else{
                $("#story_div").css("display","none");
            }
        }
    }
}


function refresh_map(){
    $("#intro_container").css("opacity","1");
    $("#bg_map").attr("src", "map/"+country_data.Ename2+".png");
    $("#bg_map").css("top", ($("#country").height() - $("#bg_map").height())/2);
    $("#bg_map").css("opacity","0.3");
    $("#next_map").attr("src","map/"+country_data.Ename3+".png");
    $("#next_map").css("height",$("#next_map_container").height());
    $("#next_map").css("width","");
    $("#next_map").css("bottom",0);
    $("#next_map").css("right",0);
    $("#country_name").html(country_data.Cname2);
    $("#country_pic").attr("src", "img/"+country_data.Ename2+".jpg");
    $("#country_info").html(country_data.intro2);
    $("#next_country_name").html(country_data.Cname3);
    $("#next_country_step").html(country_data.step);
    $("#progressbar").progressbar({value: (20000-country_data.step)/200});
    $("#progress_num").html((20000-country_data.step)/200+"%");
}